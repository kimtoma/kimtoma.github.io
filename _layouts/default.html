<!DOCTYPE html>
<html lang="en" data-theme="dark">
  {% include head.html %}

  <body>
    <div class="container content">
      <header class="masthead">
        <h3 class="masthead-title">
          <a href="{{ site.baseurl }}/" title="Home">{{ site.title }}</a>

          <nav class="nav">
            {% for nav in site.nav %}
            <small><a href="{{ nav.url }}">{{ nav.title }}</a></small>
            {% endfor %}
            <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
              <svg class="theme-icon theme-icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                <line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
              </svg>
              <svg class="theme-icon theme-icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
              </svg>
            </button>
          </nav>
        </h3>
      </header>

      <main>
        {{ content }}
      </main>

      <footer class="footer">
        <small>
          &copy;
          <time datetime="{{ site.time | date_to_xmlschema }}"
            >{{ site.time | date: '%Y' }}</time
          >. kimtoma. All rights reserved.
        </small>
      </footer>
    </div>

    {% if site.ga_analytics %}
    <script>
      (function (i, s, o, g, r, a, m) {
        i["GoogleAnalyticsObject"] = r;
        (i[r] =
          i[r] ||
          function () {
            (i[r].q = i[r].q || []).push(arguments);
          }),
          (i[r].l = 1 * new Date());
        (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m);
      })(
        window,
        document,
        "script",
        "https://www.google-analytics.com/analytics.js",
        "ga"
      );
      ga("create", "{{ site.ga_analytics }}", "auto");
      ga("send", "pageview");
    </script>
    {% endif %}

    <script data-cfasync="false">
      (function() {
        const toggle = document.getElementById('theme-toggle');
        const html = document.documentElement;
        const STORAGE_KEY = 'theme';
        const sunIcon = toggle.querySelector('.theme-icon-sun');
        const moonIcon = toggle.querySelector('.theme-icon-moon');

        function getStoredTheme() {
          return localStorage.getItem(STORAGE_KEY);
        }

        function setTheme(theme) {
          html.setAttribute('data-theme', theme);
          localStorage.setItem(STORAGE_KEY, theme);
          updateIcon(theme);
        }

        function updateIcon(theme) {
          if (theme === 'dark') {
            sunIcon.style.display = 'block';
            moonIcon.style.display = 'none';
          } else {
            sunIcon.style.display = 'none';
            moonIcon.style.display = 'block';
          }
        }

        // Initialize theme
        const storedTheme = getStoredTheme();
        if (storedTheme) {
          setTheme(storedTheme);
        } else {
          updateIcon('dark');
        }

        // Toggle handler with View Transition API
        toggle.addEventListener('click', function(event) {
          const current = html.getAttribute('data-theme');
          const next = current === 'dark' ? 'light' : 'dark';

          // Fallback for browsers without View Transition API
          if (!document.startViewTransition) {
            setTheme(next);
            return;
          }

          // Get click position for circular animation
          const x = event.clientX;
          const y = event.clientY;
          // Calculate max radius to cover entire screen
          const maxRadius = Math.hypot(
            Math.max(x, window.innerWidth - x),
            Math.max(y, window.innerHeight - y)
          );

          // Start view transition with circular reveal
          const transition = document.startViewTransition(function() {
            setTheme(next);
          });

          transition.ready.then(function() {
            const clipPath = [
              'circle(0px at ' + x + 'px ' + y + 'px)',
              'circle(' + maxRadius + 'px at ' + x + 'px ' + y + 'px)'
            ];

            // Animate based on theme direction
            document.documentElement.animate(
              { clipPath: next === 'dark' ? clipPath.reverse() : clipPath },
              {
                duration: 500,
                easing: 'ease-out',
                pseudoElement: next === 'dark'
                  ? '::view-transition-old(root)'
                  : '::view-transition-new(root)'
              }
            );
          });
        });
      })();
    </script>
  </body>
</html>
